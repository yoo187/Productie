<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Productie App Pro v8.1</title>
    <style>
        :root {
            --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #ca8a04;
            --bg: #f8fafc; --card: #ffffff; --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 10px; padding-bottom: 90px; }
        .container { max-width: 800px; margin: 0 auto; }

        .search-container { background: #fff; padding: 15px; border-radius: var(--radius); margin-bottom: 12px; border: 2px solid var(--primary); }
        .app-header { background: #1e293b; color: white; padding: 15px; border-radius: var(--radius); margin-bottom: 12px; }
        .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; color: #94a3b8; margin-bottom: 3px; text-transform: uppercase; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #fff; }

        .transport-toggle { display: flex; background: #334155; padding: 3px; border-radius: 8px; }
        .transport-toggle input { display: none; }
        .transport-toggle label { flex: 1; text-align: center; padding: 6px; cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .transport-toggle input:checked + label { background: var(--primary); color: white; }

        .card { background: var(--card); border-radius: var(--radius); margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border-left: 8px solid #cbd5e1; }
        .card.status-done { border-left-color: var(--success); }
        .card.status-pending { border-left-color: var(--danger); }
        .card.active-timer { border-left-color: var(--warning); background: #fffbeb; }
        .card-header { padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card.collapsed .card-body { display: none; }
        .card-body { padding: 12px; border-top: 1px solid #f1f5f9; }

        .prod-row { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e2e8f0; position: relative; }
        .btn-row-del { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; z-index: 10; }
        
        .timer-display { background: #0f172a; color: #fff; text-align: center; padding: 5px; border-radius: 6px; font-size: 1.2rem; font-weight: 700; font-family: monospace; margin-bottom: 8px; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 0.85rem; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; }

        .footer-stats { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #e2e8f0; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }

        @media print {
            .container, .footer-stats, .search-container, .app-header { display: none !important; }
            #print-report { display: block !important; }
        }
    </style>
</head>
<body>

<div id="print-report" style="display:none">
    <div style="border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end;">
        <h1>Productieverslag</h1>
        <div id="p-meta-info" style="text-align:right"></div>
    </div>
    <table id="p-table-body" style="width:100%; border-collapse: collapse;"></table>
</div>

<div class="container">
    <div class="search-container">
        <label>üîç Zoek Dossier-nr (Historiek)</label>
        <input type="text" id="globalSearch" placeholder="Dossiernr..." oninput="searchArchive()">
        <div id="searchResults" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
    </div>

    <div class="app-header">
        <div class="header-grid">
            <div>
                <label>Operator</label>
                <input type="text" id="operator" placeholder="Naam" oninput="save()">
            </div>
            <div>
                <label>Vervoer</label>
                <div class="transport-toggle">
                    <input type="radio" name="tr" id="f" value="Fiets" checked onchange="save()">
                    <label for="f">üö≤</label>
                    <input type="radio" name="tr" id="a" value="Wagen" onchange="save()">
                    <label for="a">üöó</label>
                </div>
            </div>
        </div>
        <div style="margin-top:10px">
            <label>Datum</label>
            <input type="date" id="datum" onchange="load()">
        </div>
    </div>

    <div id="klantenLijst"></div>
    <button class="btn btn-main" onclick="voegKlantToe()">+ NIEUWE KLANT TOEVOEGEN</button>
</div>

<div class="footer-stats">
    <div>
        <span style="font-size:0.6rem; font-weight:800; color:#64748b;">UREN TOTAAL</span>
        <div id="dagTotaal" style="font-size:1.4rem; font-weight:900; color:var(--primary)">0.00</div>
    </div>
    <button class="btn" style="background:#1e293b; color:white;" onclick="prepPrint()">üìÑ AFDRUKKEN</button>
</div>

<script>
    const TYPES = ["Raam kader", "Raam vleugel", "Deur kader", "Deur vleugel", "Schuifraam kader", "Schuifraam vleugel", "T-profiel", "Glaslatten", "Beslag", "Opkuisen", "Montage", "Andere"];
    let activeTimerId = null;
    let timerInterval = null;

    function save() {
        const date = document.getElementById('datum').value;
        const data = {
            op: document.getElementById('operator').value,
            tr: document.querySelector('input[name="tr"]:checked').value,
            activeTimerId: activeTimerId,
            klanten: [...document.querySelectorAll('.card')].map(c => ({
                id: c.id,
                n: c.querySelector('.in-n').value,
                d: c.querySelector('.in-d').value,
                st: c.dataset.status || '',
                rows: [...c.querySelectorAll('.prod-row')].map(r => ({
                    id: r.id,
                    t: r.querySelector('.sel-t').value,
                    u: r.querySelector('.in-u').value,
                    o: r.querySelector('.in-o').value,
                    s: parseInt(r.dataset.sec) || 0,
                    start: r.dataset.start || null
                }))
            }))
        };
        localStorage.setItem('prod_v8_' + date, JSON.stringify(data));
        calc();
    }

    function load() {
        clearInterval(timerInterval);
        document.getElementById('klantenLijst').innerHTML = '';
        const raw = localStorage.getItem('prod_v8_' + document.getElementById('datum').value);
        if (raw) {
            const data = JSON.parse(raw);
            document.getElementById('operator').value = data.op || '';
            document.getElementById(data.tr === 'Fiets' ? 'f' : 'a').checked = true;
            activeTimerId = data.activeTimerId || null;
            data.klanten.forEach(k => voegKlantToe(k));
            if(activeTimerId) startTick();
        } else { 
            activeTimerId = null;
            voegKlantToe(); 
        }
        calc();
    }

    function voegKlantToe(data = null) {
        const id = data?.id || 'k' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="card ${data?.st ? 'status-'+data.st : ''}" id="${id}" data-status="${data?.st || ''}">
                <div class="card-header" onclick="toggle('${id}')">
                    <div style="flex:1">
                        <span style="font-weight:800; font-size:0.9rem; display:block">${data?.n || 'Nieuwe Klant'}</span>
                        <span style="font-size:0.75rem; color:#64748b">Dossier: ${data?.d || '---'}</span>
                    </div>
                    <div style="font-weight:900; color:var(--primary)"><span class="k-uur">0.00</span>u</div>
                </div>
                <div class="card-body">
                    <div class="header-grid" style="margin-bottom:10px">
                        <input type="text" class="in-n" value="${data?.n || ''}" placeholder="Klant" oninput="sync('${id}')">
                        <input type="text" class="in-d" value="${data?.d || ''}" placeholder="Dossiernr" oninput="sync('${id}')">
                    </div>
                    <div class="rijen"></div>
                    <button class="btn" style="background:#f1f5f9; width:100%; margin-bottom:10px" onclick="voegRij('${id}')">+ Rij</button>
                    <div style="display:flex; gap:5px">
                        <button class="btn" style="background:#dcfce7; color:var(--success); flex:1" onclick="setStat('${id}', 'done')">OK</button>
                        <button class="btn" style="background:#fee2e2; color:var(--danger); flex:1" onclick="setStat('${id}', 'pending')">NIET OK</button>
                    </div>
                    <button style="border:none; color:#94a3b8; font-size:0.6rem; width:100%; margin-top:10px; background:none" onclick="delK('${id}')">KLANT WISSEN</button>
                </div>
            </div>`;
        document.getElementById('klantenLijst').insertAdjacentHTML('beforeend', html);
        if(data?.rows) data.rows.forEach(r => voegRij(id, r)); else voegRij(id);
    }

    function voegRij(kid, r = null) {
        const rid = r?.id || 'r' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="prod-row" id="${rid}" data-sec="${r?.s || 0}" data-start="${r?.start || ''}">
                <button class="btn-row-del" onclick="delR('${rid}')">√ó</button>
                <div class="timer-display">${fmt(r?.s || 0)}</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px">
                    <button class="btn btn-start" style="background:var(--warning); color:white; padding:8px" onclick="tglT('${rid}', true)">START</button>
                    <button class="btn" style="background:#64748b; color:white; padding:8px" onclick="tglT('${rid}', false)">STOP</button>
                </div>
                <div class="header-grid">
                    <select class="sel-t" onchange="save()">${TYPES.map(t => `<option ${r?.t === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                    <input type="number" class="in-u" value="${r?.u || '0.00'}" step="0.25" oninput="save()">
                </div>
                <textarea class="in-o" placeholder="Opmerking..." oninput="save()" rows="1" style="margin-top:5px; font-size:14px">${r?.o || ''}</textarea>
            </div>`;
        document.getElementById(kid).querySelector('.rijen').insertAdjacentHTML('beforeend', html);
    }

    function tglT(rid, start) {
        const el = document.getElementById(rid);
        if(start) {
            if(activeTimerId) tglT(activeTimerId, false); // Stop vorige
            activeTimerId = rid;
            el.dataset.start = Date.now();
            el.closest('.card').classList.add('active-timer');
            startTick();
        } else {
            if(activeTimerId === rid) {
                const elapsed = Math.floor((Date.now() - parseInt(el.dataset.start)) / 1000);
                el.dataset.sec = (parseInt(el.dataset.sec) || 0) + elapsed;
                el.dataset.start = '';
                activeTimerId = null;
                clearInterval(timerInterval);
                // Bereken uren (afronden op kwartier)
                el.querySelector('.in-u').value = (Math.round((parseInt(el.dataset.sec)/3600)*4)/4).toFixed(2);
                el.closest('.card').classList.remove('active-timer');
            }
        }
        save();
    }

    function startTick() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if(!activeTimerId) return;
            const el = document.getElementById(activeTimerId);
            const currentElapsed = Math.floor((Date.now() - parseInt(el.dataset.start)) / 1000);
            const totalSec = (parseInt(el.dataset.sec) || 0) + currentElapsed;
            el.querySelector('.timer-display').innerText = fmt(totalSec);
        }, 1000);
    }

    function fmt(s) {
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    }

    function calc() {
        let dagTotaal = 0;
        document.querySelectorAll('.card').forEach(card => {
            let klantTotaal = 0;
            card.querySelectorAll('.in-u').forEach(input => {
                klantTotaal += parseFloat(input.value) || 0;
            });
            card.querySelector('.k-uur').innerText = klantTotaal.toFixed(2);
            dagTotaal += klantTotaal;
        });
        document.getElementById('dagTotaal').innerText = dagTotaal.toFixed(2);
    }

    function sync(id) {
        const c = document.getElementById(id);
        c.querySelector('span:first-child').innerText = c.querySelector('.in-n').value || 'Nieuwe Klant';
        c.querySelector('span:nth-child(2)').innerText = 'Dossier: ' + c.querySelector('.in-d').value;
        save();
    }

    function toggle(id) {
        if(!event.target.closest('input, button, select, textarea')) {
            document.getElementById(id).classList.toggle('collapsed');
        }
    }

    function setStat(id, s) {
        const el = document.getElementById(id);
        el.dataset.status = s;
        el.classList.remove('status-done', 'status-pending');
        if(s) el.classList.add('status-'+s);
        save();
    }

    function delR(rid) { if(confirm("Rij wissen?")) { document.getElementById(rid).remove(); save(); } }
    function delK(id) { if(confirm("Klant wissen?")) { document.getElementById(id).remove(); save(); } }

    function searchArchive() {
        const q = document.getElementById('globalSearch').value.toLowerCase();
        const res = document.getElementById('searchResults');
        if(q.length < 2) { res.innerHTML = ''; return; }
        let h = '';
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('prod_v8_')) {
                const d = JSON.parse(localStorage.getItem(k));
                d.klanten.forEach(kl => {
                    if(kl.d.toLowerCase().includes(q)) h += `<div onclick="goToDate('${k.replace('prod_v8_','')}')" style="padding:8px; border-bottom:1px solid #eee; font-size:0.8rem; cursor:pointer"><strong>${k.replace('prod_v8_','')}</strong> - ${kl.n} (${kl.d})</div>`;
                });
            }
        }
        res.innerHTML = h || 'Geen resultaten';
    }

    function goToDate(d) { document.getElementById('datum').value = d; load(); document.getElementById('searchResults').innerHTML = ''; }

    function prepPrint() {
        const op = document.getElementById('operator').value || '...';
        const dat = document.getElementById('datum').value;
        const vText = document.querySelector('input[name="tr"]:checked').value;
        document.getElementById('p-meta-info').innerHTML = `Operator: ${op}<br>Datum: ${dat}<br>Vervoer: ${vText}`;
        let tableHtml = `<tr><th style="border:1px solid #000;padding:5px">Klant/Dossier</th><th style="border:1px solid #000;padding:5px">Type</th><th style="border:1px solid #000;padding:5px">Uren</th><th style="border:1px solid #000;padding:5px">Opmerking</th></tr>`;
        document.querySelectorAll('.card').forEach(c => {
            const n = c.querySelector('.in-n').value;
            const d = c.querySelector('.in-d').value;
            const rows = c.querySelectorAll('.prod-row');
            rows.forEach((r, idx) => {
                tableHtml += `<tr>
                    ${idx === 0 ? `<td rowspan="${rows.length}" style="border:1px solid #000;padding:5px"><strong>${n}</strong><br>${d}</td>` : ''}
                    <td style="border:1px solid #000;padding:5px">${r.querySelector('.sel-t').value}</td>
                    <td style="border:1px solid #000;padding:5px">${r.querySelector('.in-u').value}u</td>
                    <td style="border:1px solid #000;padding:5px">${r.querySelector('.in-o').value}</td>
                </tr>`;
            });
        });
        document.getElementById('p-table-body').innerHTML = tableHtml;
        window.print();
    }

    window.onload = () => { 
        if(!document.getElementById('datum').value) {
            document.getElementById('datum').value = new Date().toISOString().split('T')[0];
        }
        load(); 
    };
</script>

</body>
</html>
