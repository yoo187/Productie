<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Productie Registratie</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial,sans-serif;background:#f2f4f7}
.app{padding:12px}
h1{text-align:center;font-size:1.6rem;margin:12px 0 20px}
input, select, textarea{
  padding:12px;font-size:1rem;border-radius:10px;border:1px solid #ccc;
  margin-bottom:12px;display:block;width:100%;
}
.controls{display:flex;gap:10px;margin-bottom:16px;justify-content:center;flex-wrap:wrap}
button{padding:12px;border-radius:10px;border:none;cursor:pointer}
.add{background:#2ecc71;color:#fff}
.remove{background:#e74c3c;color:#fff}
.done{background:#27ae60;color:#fff}
.notdone{background:#c0392b;color:#fff}
.delete-klant{background:#555;color:#fff}
.card{background:#fff;border-radius:16px;padding:14px;margin-bottom:16px;border-left:8px solid #ccc}
.card-header{display:flex;justify-content:space-between;cursor:pointer;font-weight:bold}
.card.collapsed .card-body{display:none}
.badge{padding:4px 10px;border-radius:12px;color:#fff}
.badge.progress{background:#f39c12}
.badge.done{background:#27ae60}
.badge.notdone{background:#c0392b}
.productie-row{border:2px solid #ddd;padding:10px;border-radius:10px;margin-bottom:10px}
.productie-row.done-row{border-color:#27ae60;background:#eafaf1}
.productie-row.notdone-row{border-color:#c0392b;background:#fde6e0}
.actions{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head>

<body>
<div class="app">
<h1>Productie Registratie</h1>

<label>Naam operator</label>
<input id="operatorNaam">

<label>Vervoer</label>
<select id="vervoerSelect">
  <option value="Fiets">Fiets</option>
  <option value="Auto">Auto</option>
</select>

<input type="date" id="datum">
<input placeholder="Zoeken dossier" oninput="zoekDossier(this.value)">

<div class="controls">
<button onclick="allesUitklappen()">Alles uitklappen</button>
<button onclick="allesInklappen()">Alles inklappen</button>
<button onclick="window.print()">Print</button>
</div>

<div id="zoekResultaten"></div>
<div id="productieCards"></div>

<button class="add" onclick="nieuweKlant()">Nieuwe klant</button>
<h3>Dag totaal: <span id="dagTotaal">0.00</span></h3>
</div>

<script>
/* ðŸ”’ BEVEILIGING TEGEN DATA VERLIES */
let isAanHetLaden = false;

const datum = document.getElementById("datum");
const productieCards = document.getElementById("productieCards");
const zoekResultaten = document.getElementById("zoekResultaten");
const operatorNaam = document.getElementById("operatorNaam");
const vervoerSelect = document.getElementById("vervoerSelect");
const dagTotaal = document.getElementById("dagTotaal");

function zetVandaag(){
  const d = new Date();
  datum.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function key(){ return "productie-"+datum.value }

function nieuweKlant(data=null){
  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
  <div class="card-header" onclick="c.classList.toggle('collapsed')">
    <div>${data?.klant||"â€”"} | ${data?.dossier||"â€”"}</div>
    <span class="badge progress">â€¦</span>
  </div>
  <div class="card-body">
    <input placeholder="Klant" value="${data?.klant||""}" oninput="opslaan()">
    <input placeholder="Dossier" value="${data?.dossier||""}" oninput="opslaan()">
    ${(data?.rijen||[{}]).map(rijHTML).join("")}
    <button class="add" onclick="addRij(this)">Rij toevoegen</button>
    <button class="delete-klant" onclick="this.closest('.card').remove();opslaan()">Verwijder klant</button>
  </div>`;
  productieCards.appendChild(c);
}

function rijHTML(r={}){return `
<div class="productie-row ${r.status||""}">
<input placeholder="Type" value="${r.type||""}">
<input type="number" placeholder="Uren" value="${r.uren||0}" class="uren-input">
<div class="actions">
<button class="done" onclick="mark(this,'done-row')">âœ”</button>
<button class="notdone" onclick="mark(this,'notdone-row')">âœ–</button>
<button class="remove" onclick="this.closest('.productie-row').remove();opslaan()">X</button>
</div></div>`}

function addRij(b){b.insertAdjacentHTML("beforebegin",rijHTML());opslaan()}
function mark(b,s){b.closest(".productie-row").className="productie-row "+s;opslaan()}

function bereken(){
  let t=0;
  document.querySelectorAll(".uren-input").forEach(i=>t+=+i.value||0);
  dagTotaal.textContent=t.toFixed(2);
}

function opslaan(){
  if(isAanHetLaden) return;   // â›” BELANGRIJK

  bereken();
  const data={
    operator:operatorNaam.value,
    vervoer:vervoerSelect.value,
    klanten:[...document.querySelectorAll(".card")].map(c=>({
      klant:c.querySelectorAll("input")[0].value,
      dossier:c.querySelectorAll("input")[1].value,
      rijen:[...c.querySelectorAll(".productie-row")].map(r=>({
        type:r.querySelector("input").value,
        uren:r.querySelector(".uren-input").value,
        status:r.classList.contains("done-row")?"done-row":
               r.classList.contains("notdone-row")?"notdone-row":""
      }))
    }))
  };
  localStorage.setItem(key(),JSON.stringify(data));
}

function laadDag(){
  isAanHetLaden = true;

  productieCards.innerHTML="";
  zoekResultaten.innerHTML="";
  const d = JSON.parse(localStorage.getItem(key())||"null");

  if(!d){
    operatorNaam.value="";
    vervoerSelect.value="Fiets";
    nieuweKlant();
  } else {
    operatorNaam.value=d.operator||"";
    vervoerSelect.value=d.vervoer||"Fiets";
    d.klanten.forEach(nieuweKlant);
  }

  bereken();
  isAanHetLaden = false;
}

datum.addEventListener("change",laadDag);

window.addEventListener("load",()=>{
  zetVandaag();
  laadDag();
});
</script>

</body>
</html>
