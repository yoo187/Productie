<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Productie App Enterprise v7</title>
    <style>
        :root {
            --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #ca8a04;
            --bg: #f8fafc; --card: #ffffff; --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: #1e293b; padding: 10px; padding-bottom: 90px; }
        .container { max-width: 800px; margin: 0 auto; }

        /* Zoek Systeem */
        .search-container { background: #fff; padding: 15px; border-radius: var(--radius); margin-bottom: 15px; border: 2px solid var(--primary); }
        .search-results { margin-top: 10px; max-height: 250px; overflow-y: auto; display: none; border-top: 1px solid #eee; }
        .result-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .result-item:hover { background: #f1f5ff; }

        /* Header */
        .app-header { background: #1e293b; color: white; padding: 15px; border-radius: var(--radius); margin-bottom: 12px; }
        .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; color: #94a3b8; margin-bottom: 3px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; background: #fff; }

        /* Vervoer */
        .transport-toggle { display: flex; background: #334155; padding: 3px; border-radius: 8px; }
        .transport-toggle input { display: none; }
        .transport-toggle label { flex: 1; text-align: center; padding: 6px; margin: 0; cursor: pointer; border-radius: 6px; font-size: 1.2rem; }
        .transport-toggle input:checked + label { background: var(--primary); color: white; }

        /* Cards */
        .card { background: var(--card); border-radius: var(--radius); margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; border-left: 8px solid #cbd5e1; }
        .card.status-done { border-left-color: var(--success); }
        .card.status-pending { border-left-color: var(--danger); }
        .card.active { border-left-color: var(--warning); background: #fffbeb; }
        .card-header { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; border-top: 1px solid #f1f5f9; }
        .card.collapsed .card-body { display: none; }

        /* Rows met Delete optie */
        .prod-row { background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; position: relative; }
        .btn-row-del { position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        
        .timer-display { background: #0f172a; color: #fff; text-align: center; padding: 8px; border-radius: 6px; font-size: 1.3rem; font-weight: 700; font-family: monospace; margin-bottom: 8px; }
        
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .footer-stats { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #e2e8f0; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }

        @media print {
            .app-header, .btn, .footer-stats, .transport-toggle, .search-container, .btn-row-del, .btn-grid { display: none !important; }
            .card { border: 1px solid #ddd !important; border-left: 12px solid #ddd !important; break-inside: avoid; }
            .prod-row { border: none; border-bottom: 1px solid #eee; padding: 5px 0; margin: 0; display: grid; grid-template-columns: 1fr 0.5fr 2fr; }
            .timer-display, textarea { font-size: 10pt !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="search-container">
        <label>üîç Zoek Dossier in Archief</label>
        <input type="text" id="globalSearch" placeholder="Dossier-nr invoeren..." oninput="searchArchive()">
        <div id="searchResults" class="search-results"></div>
    </div>

    <div class="app-header">
        <div class="header-grid">
            <div>
                <label>Operator</label>
                <input type="text" id="operator" placeholder="Naam" oninput="save()">
            </div>
            <div>
                <label>Vervoer</label>
                <div class="transport-toggle">
                    <input type="radio" name="tr" id="f" value="Fiets" checked onchange="save()">
                    <label for="f">üö≤</label>
                    <input type="radio" name="tr" id="a" value="Wagen" onchange="save()">
                    <label for="a">üöó</label>
                </div>
            </div>
        </div>
        <div style="margin-top:10px">
            <label>Datum</label>
            <input type="date" id="datum" onchange="load()">
        </div>
    </div>

    <div id="klantenLijst"></div>
    <button class="btn btn-main" onclick="voegKlantToe()">+ NIEUWE KLANT TOEVOEGEN</button>
</div>

<div class="footer-stats">
    <div class="total-box">
        <span style="font-size: 0.65rem; font-weight: 800; color: #64748b;">TOTAAL UREN</span>
        <div id="dagTotaal">0.00</div>
    </div>
    <button class="btn" style="background: #1e293b; color: white;" onclick="window.print()">üìÑ AFDRUKKEN</button>
</div>

<script>
    const TYPES = ["Raam kader", "Raam vleugel", "Deur kader", "Deur vleugel", "Schuifraam kader", "Schuifraam vleugel", "T-profiel", "Glaslatten", "Beslag", "Opkuisen", "Montage", "Andere"];
    let timerInt = null;

    function searchArchive() {
        const query = document.getElementById('globalSearch').value.toLowerCase();
        const resultsDiv = document.getElementById('searchResults');
        if (query.length < 2) { resultsDiv.style.display = 'none'; return; }

        let matches = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('prod_v7_')) {
                const dayData = JSON.parse(localStorage.getItem(key));
                const dateStr = key.replace('prod_v7_', '');
                dayData.klanten.forEach(k => {
                    if (k.d.toLowerCase().includes(query)) {
                        k.rows.forEach(r => {
                            matches.push({ date: dateStr, client: k.n, dossier: k.d, type: r.t, hours: r.u });
                        });
                    }
                });
            }
        }
        if (matches.length > 0) {
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = matches.map(m => `
                <div class="result-item" onclick="goToDate('${m.date}')">
                    <div><strong style="color:var(--primary)">${m.date}</strong> | ${m.client}</div>
                    <div style="text-align:right"><strong>${m.hours}u</strong><br><small>${m.type}</small></div>
                </div>
            `).join('');
        } else {
            resultsDiv.innerHTML = '<div class="result-item">Geen resultaten</div>';
        }
    }

    function goToDate(date) {
        document.getElementById('datum').value = date;
        document.getElementById('globalSearch').value = '';
        document.getElementById('searchResults').style.display = 'none';
        load();
    }

    function save() {
        const date = document.getElementById('datum').value;
        const data = {
            op: document.getElementById('operator').value,
            tr: document.querySelector('input[name="tr"]:checked').value,
            klanten: [...document.querySelectorAll('.card')].map(c => ({
                n: c.querySelector('.in-n').value,
                d: c.querySelector('.in-d').value,
                cl: c.classList.contains('collapsed'),
                st: c.dataset.status || '',
                rows: [...c.querySelectorAll('.prod-row')].map(r => ({
                    t: r.querySelector('.sel-t').value,
                    s: r.dataset.sec,
                    u: r.querySelector('.in-u').value,
                    o: r.querySelector('.in-o').value
                }))
            }))
        };
        localStorage.setItem('prod_v7_' + date, JSON.stringify(data));
        calc();
    }

    function load() {
        document.getElementById('klantenLijst').innerHTML = '';
        const raw = localStorage.getItem('prod_v7_' + document.getElementById('datum').value);
        if (raw) {
            const data = JSON.parse(raw);
            document.getElementById('operator').value = data.op || '';
            document.getElementById(data.tr === 'Fiets' ? 'f' : 'a').checked = true;
            data.klanten.forEach(k => voegKlantToe(k));
        } else { voegKlantToe(); }
        calc();
    }

    function voegKlantToe(data = null) {
        const id = 'k' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="card ${data?.cl ? 'collapsed' : ''} ${data?.st ? 'status-'+data.st : ''}" id="${id}" data-status="${data?.st || ''}">
                <div class="card-header" onclick="toggle('${id}')">
                    <div style="flex:1">
                        <span style="font-weight:800; font-size:1rem; display:block">${data?.n || 'Nieuwe Klant'}</span>
                        <span style="font-family:monospace; font-size:0.8rem; color:#64748b">Dossier: ${data?.d || '---'}</span>
                    </div>
                    <div style="font-weight:900; color:var(--primary)"><span class="k-uur">0.00</span>u</div>
                </div>
                <div class="card-body">
                    <div class="header-grid" style="margin-bottom:12px">
                        <div><label>Klant</label><input type="text" class="in-n" value="${data?.n || ''}" oninput="sync('${id}')"></div>
                        <div><label>Dossiernr</label><input type="text" class="in-d" value="${data?.d || ''}" oninput="sync('${id}')"></div>
                    </div>
                    <div class="rijen"></div>
                    <button class="btn" style="background:#f1f5f9; color:#475569; width:100%; margin-bottom:10px" onclick="voegRij('${id}')">+ RIJ TOEVOEGEN</button>
                    <div style="display:flex; gap:8px">
                        <button class="btn" style="background:#dcfce7; color:var(--success); flex:1" onclick="setStat('${id}', 'done')">VOLTOOID</button>
                        <button class="btn" style="background:#fee2e2; color:var(--danger); flex:1" onclick="setStat('${id}', 'pending')">NIET KLAAR</button>
                    </div>
                    <button style="background:none; border:none; color:#94a3b8; font-size:0.7rem; width:100%; margin-top:15px; cursor:pointer;" onclick="delK('${id}')">VERWIJDER KLANT</button>
                </div>
            </div>`;
        document.getElementById('klantenLijst').insertAdjacentHTML('beforeend', html);
        if(data?.rows) data.rows.forEach(r => voegRij(id, r)); else voegRij(id);
    }

    function voegRij(kid, r = null) {
        const rid = 'r' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="prod-row" id="${rid}" data-sec="${r?.s || 0}">
                <button class="btn-row-del" onclick="delR('${rid}')">√ó</button>
                <div class="timer-display">${fmt(r?.s || 0)}</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:8px" class="btn-grid">
                    <button class="btn" style="background:var(--warning); color:white" onclick="tglT('${rid}', true)">START</button>
                    <button class="btn" style="background:#64748b; color:white" onclick="tglT('${rid}', false)">STOP</button>
                </div>
                <div class="header-grid">
                    <select class="sel-t" onchange="save()">${TYPES.map(t => `<option ${r?.t === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                    <input type="number" class="in-u" value="${r?.u || '0.00'}" step="0.25" oninput="save()">
                </div>
                <textarea class="in-o" placeholder="Opmerking..." oninput="save()" rows="1" style="margin-top:8px">${r?.o || ''}</textarea>
            </div>`;
        document.getElementById(kid).querySelector('.rijen').insertAdjacentHTML('beforeend', html);
        save();
    }

    function delR(rid) { if(confirm("Rij wissen?")) { document.getElementById(rid).remove(); save(); } }
    function delK(id) { if(confirm("Klant wissen?")) { document.getElementById(id).remove(); save(); } }

    function tglT(rid, start) {
        const el = document.getElementById(rid);
        clearInterval(timerInt);
        if (start) {
            timerInt = setInterval(() => {
                el.dataset.sec = parseInt(el.dataset.sec) + 1;
                el.querySelector('.timer-display').innerText = fmt(el.dataset.sec);
            }, 1000);
        } else {
            const h = (Math.round((parseInt(el.dataset.sec)/60)/15)*0.25).toFixed(2);
            el.querySelector('.in-u').value = h;
            save();
        }
    }

    function fmt(s) {
        const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function sync(id) {
        const c = document.getElementById(id);
        c.querySelector('.card-header span:first-child').innerText = c.querySelector('.in-n').value || 'Nieuwe Klant';
        c.querySelector('.card-header span:last-child').innerText = 'Dossier: ' + (c.querySelector('.in-d').value || '---');
        save();
    }

    function toggle(id) {
        if(event.target.closest('input') || event.target.closest('button') || event.target.closest('select')) return;
        document.getElementById(id).classList.toggle('collapsed');
        save();
    }

    function setStat(id, stat) {
        const el = document.getElementById(id);
        el.dataset.status = stat;
        el.classList.remove('status-done', 'status-pending');
        el.classList.add('status-' + stat);
        save();
    }

    function calc() {
        let dag = 0;
        document.querySelectorAll('.card').forEach(c => {
            let kt = 0;
            c.querySelectorAll('.in-u').forEach(i => kt += parseFloat(i.value) || 0);
            c.querySelector('.k-uur').innerText = kt.toFixed(2);
            dag += kt;
        });
        document.getElementById('dagTotaal').innerText = dag.toFixed(2);
    }

    window.onload = () => {
        document.getElementById('datum').value = new Date().toISOString().split('T')[0];
        load();
    };
</script>

</body>
</html>
