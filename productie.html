<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Productie App</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ca8a04;
            --bg: #f1f5f9;
            --card: #ffffff;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { 
            background: var(--bg); 
            color: #1e293b; 
            padding: 10px;
            padding-bottom: 100px; /* Ruimte voor de sticky footer */
        }

        .container { max-width: 800px; margin: 0 auto; }

        /* Header & Daginfo */
        .app-header { background: #1e293b; color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 15px; }
        .app-header h1 { font-size: 1.2rem; margin-bottom: 15px; text-align: center; opacity: 0.9; }
        
        .header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Inputs */
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; /* 16px voorkomt auto-zoom op iPhone */
            background: #fff;
        }

        /* Vervoer Selectie */
        .transport-toggle { display: flex; background: #334155; padding: 4px; border-radius: 8px; }
        .transport-toggle input { display: none; }
        .transport-toggle label { 
            flex: 1; text-align: center; padding: 8px; margin: 0; color: #94a3b8; 
            cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .transport-toggle input:checked + label { background: var(--primary); color: white; }

        /* De Kaarten (Klanten) */
        .card { 
            background: var(--card); border-radius: var(--radius); margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: hidden;
            border-left: 5px solid #cbd5e1;
        }
        .card.active { border-left-color: var(--warning); background: #fffbeb; }
        .card.done { border-left-color: var(--success); }

        .card-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .header-main { flex: 1; }
        .client-title { font-weight: 800; font-size: 1.1rem; color: #0f172a; display: block; }
        .dossier-sub { font-size: 0.85rem; color: #64748b; font-family: monospace; }

        .card-body { padding: 15px; border-top: 1px solid #f1f5f9; }
        .card.collapsed .card-body { display: none; }

        /* Productie Rijen */
        .prod-row { 
            background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .timer-display { 
            grid-column: span 2; background: #0f172a; color: #fff; 
            text-align: center; padding: 10px; border-radius: 6px;
            font-size: 1.4rem; font-weight: 700; font-family: monospace;
        }

        /* Buttons */
        .btn { 
            padding: 12px; border-radius: 8px; border: none; font-weight: 700; 
            cursor: pointer; font-size: 0.9rem; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-start { background: var(--warning); color: white; width: 100%; }
        .btn-stop { background: #475569; color: white; width: 100%; }
        .btn-add { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-action { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
        .btn-done { background: var(--success); color: white; }

        /* Sticky Footer */
        .footer-stats {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #fff; border-top: 1px solid #e2e8f0;
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); z-index: 100;
        }

        .total-box { line-height: 1; }
        .total-box span { font-size: 0.7rem; color: #64748b; font-weight: 700; }
        .total-box div { font-size: 1.5rem; font-weight: 900; color: var(--primary); }

        @media print { .footer-stats, .btn, .transport-toggle { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h1>Productie Registratie</h1>
        <div class="header-grid">
            <div>
                <label>Operator</label>
                <input type="text" id="operator" placeholder="Naam" oninput="save()">
            </div>
            <div>
                <label>Vervoer</label>
                <div class="transport-toggle">
                    <input type="radio" name="tr" id="f" value="Fiets" checked onchange="save()">
                    <label for="f">ðŸš²</label>
                    <input type="radio" name="tr" id="a" value="Auto" onchange="save()">
                    <label for="a">ðŸš—</label>
                </div>
            </div>
        </div>
        <div style="margin-top:10px">
            <label>Datum</label>
            <input type="date" id="datum" onchange="load()">
        </div>
    </div>

    <div id="klantenLijst"></div>

    <button class="btn btn-add" style="width: 100%;" onclick="voegKlantToe()">+ NIEUWE KLANT</button>
</div>

<div class="footer-stats">
    <div class="total-box">
        <span>DAG TOTAAL</span>
        <div id="dagTotaal">0.00</div>
    </div>
    <button class="btn btn-done" onclick="window.print()">EXPORT PDF</button>
</div>

<script>
    const TYPES = ["Raam kader", "Raam vleugel", "Deur kader", "Deur vleugel", "Schuifraam kader", "Schuifraam vleugel", "T-profiel", "Glaslatten", "Beslag", "Opkuisen", "Montage", "Andere"];
    let timerIdx = null;
    let timerInt = null;

    function save() {
        const data = {
            op: document.getElementById('operator').value,
            tr: document.querySelector('input[name="tr"]:checked').value,
            klanten: [...document.querySelectorAll('.card')].map(c => ({
                n: c.querySelector('.in-n').value,
                d: c.querySelector('.in-d').value,
                cl: c.classList.contains('collapsed'),
                rows: [...c.querySelectorAll('.prod-row')].map(r => ({
                    t: r.querySelector('.sel-t').value,
                    s: r.dataset.sec,
                    u: r.querySelector('.in-u').value,
                    o: r.querySelector('.in-o').value,
                    st: r.dataset.status
                }))
            }))
        };
        localStorage.setItem('prod_v3_' + document.getElementById('datum').value, JSON.stringify(data));
        calc();
    }

    function load() {
        document.getElementById('klantenLijst').innerHTML = '';
        const raw = localStorage.getItem('prod_v3_' + document.getElementById('datum').value);
        if (raw) {
            const data = JSON.parse(raw);
            document.getElementById('operator').value = data.op;
            document.getElementById(data.tr === 'Fiets' ? 'f' : 'a').checked = true;
            data.klanten.forEach(k => voegKlantToe(k));
        } else {
            voegKlantToe();
        }
        calc();
    }

    function voegKlantToe(data = null) {
        const id = 'k' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="card ${data?.cl ? 'collapsed' : ''}" id="${id}">
                <div class="card-header" onclick="toggle('${id}')">
                    <div class="header-main">
                        <span class="client-title">${data?.n || 'Nieuwe Klant'}</span>
                        <span class="dossier-sub">Dossier: ${data?.d || '---'}</span>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:900; color:var(--primary)"><span class="k-uur">0.00</span>u</div>
                        <div style="font-size:0.6rem; color:#94a3b8">TIJK</div>
                    </div>
                </div>
                <div class="card-body">
                    <label>Klantnaam</label>
                    <input type="text" class="in-n" value="${data?.n || ''}" oninput="sync('${id}')" style="margin-bottom:10px">
                    <label>Dossiernummer</label>
                    <input type="text" class="in-d" value="${data?.d || ''}" oninput="sync('${id}')" style="margin-bottom:15px">
                    <div class="rijen"></div>
                    <button class="btn btn-action" style="width:100%" onclick="voegRij('${id}')">+ RIJ TOEVOEGEN</button>
                    <button onclick="del('${id}')" style="width:100%; background:none; border:none; color:var(--danger); margin-top:15px; font-size:0.8rem; font-weight:700">KLANT VERWIJDEREN</button>
                </div>
            </div>`;
        document.getElementById('klantenLijst').insertAdjacentHTML('beforeend', html);
        if(data?.rows) data.rows.forEach(r => voegRij(id, r)); else voegRij(id);
    }

    function voegRij(kid, r = null) {
        const rid = 'r' + Math.random().toString(36).substr(2,5);
        const html = `
            <div class="prod-row" id="${rid}" data-sec="${r?.s || 0}" data-status="${r?.st || ''}">
                <div class="timer-display">${fmt(r?.s || 0)}</div>
                <div class="row-grid">
                    <button class="btn btn-start" onclick="tglT('${rid}', true)">START</button>
                    <button class="btn btn-stop" onclick="tglT('${rid}', false)">STOP</button>
                </div>
                <div class="row-grid">
                    <div>
                        <label>Type</label>
                        <select class="sel-t" onchange="save()">
                            ${TYPES.map(t => `<option ${r?.t === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label>Uren</label>
                        <input type="number" class="in-u" value="${r?.u || '0.00'}" step="0.25" oninput="save()">
                    </div>
                </div>
                <textarea class="in-o" placeholder="Opmerking..." oninput="save()">${r?.o || ''}</textarea>
            </div>`;
        document.getElementById(kid).querySelector('.rijen').insertAdjacentHTML('beforeend', html);
    }

    function tglT(rid, start) {
        const el = document.getElementById(rid);
        clearInterval(timerInt);
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        
        if (start) {
            el.closest('.card').classList.add('active');
            timerInt = setInterval(() => {
                el.dataset.sec = parseInt(el.dataset.sec) + 1;
                el.querySelector('.timer-display').innerText = fmt(el.dataset.sec);
            }, 1000);
        } else {
            const h = (Math.round((parseInt(el.dataset.sec)/60)/15)*0.25).toFixed(2);
            el.querySelector('.in-u').value = h;
            save();
        }
    }

    function fmt(s) {
        const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    function sync(id) {
        const c = document.getElementById(id);
        c.querySelector('.client-title').innerText = c.querySelector('.in-n').value || 'Nieuwe Klant';
        c.querySelector('.dossier-sub').innerText = 'Dossier: ' + (c.querySelector('.in-d').value || '---');
        save();
    }

    function toggle(id) {
        if(event.target.closest('input') || event.target.closest('button')) return;
        document.getElementById(id).classList.toggle('collapsed');
        save();
    }

    function del(id) { if(confirm("Klant wissen?")) { document.getElementById(id).remove(); save(); } }

    function calc() {
        let dag = 0;
        document.querySelectorAll('.card').forEach(c => {
            let kt = 0;
            c.querySelectorAll('.in-u').forEach(i => kt += parseFloat(i.value) || 0);
            c.querySelector('.k-uur').innerText = kt.toFixed(2);
            dag += kt;
        });
        document.getElementById('dagTotaal').innerText = dag.toFixed(2);
    }

    window.onload = () => {
        document.getElementById('datum').value = new Date().toISOString().split('T')[0];
        load();
    };
</script>

</body>
</html>
